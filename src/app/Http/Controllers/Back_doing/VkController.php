<?php

namespace App\Http\Controllers\Back_doing;

use Illuminate\Http\Request;
use GuzzleHttp\Client;
use App\Http\Controllers\Controller;
use App\Http\Controllers\API\VkLongPollService;
use App\Jobs\VkProcessingJob;
use Illuminate\Bus\Queueable;

use App\Models\AccountListing; // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–±–∞–≤–∏–ª–∏ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç
use App\Models\Message; // –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –¥–æ–±–∞–≤–∏–ª–∏ —ç—Ç–æ—Ç –∏–º–ø–æ—Ä—Ç

class VkController extends Controller
{

    public function init(Request $request)
    {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å–∫—Ä–∏–ø—Ç–∞ –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç—å
        set_time_limit(0);

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–∞ –ª–∏ –Ω–∞–∂–∞—Ç–∞ –∫–Ω–æ–ø–∫–∞ "–°—Ç–æ–ø"
        if ($request->input('action') === 'stop') {
            session()->forget('vk_processing'); // –£–¥–∞–ª—è–µ–º —Ñ–ª–∞–≥ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑ —Å–µ—Å—Å–∏–∏
            return redirect()->back()->with('message', '–ü—Ä–æ—Ü–µ—Å—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.');
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ "–ù–∞—á–∞—Ç—å"
        $mess_pass = [
            0 => "–ü–æ–º–Ω–∏, —á—Ç–æ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ –ª—é–¥–∏ –º–æ–≥—É—Ç –≤—ã–¥–∞–≤–∞—Ç—å —Å–µ–±—è –∑–∞ –¥—Ä—É–≥–∏—Ö",
            1 => "–î–∞–π–≤–∏–Ω—á–∏–∫ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–µ–Ω –≤ Telegram",
            2 => "—ç—Ç–æ —Å–æ–≤–µ—Ç –æ—Ç –î–∞–π–≤–∏–Ω—á–∏–∫–∞ –∫–∞–∫ –Ω–µ —Å—Ç–∞—Ç—å –∂–µ—Ä—Ç–≤–æ–π –º–æ—à–µ–Ω–Ω–∏–∫–æ–≤.",
            3 => "–ø—Ä–µ–¥–ª–∞–≥–∞—é —Ç–µ–±–µ —Å–¥–µ–ª–∫—É:",
            4 => "1. –°–º–æ—Ç—Ä–µ—Ç—å –∞–Ω–∫–µ—Ç—ã.",
            5 => "–ù–∞—à–ª–∏ –∫–æ–µ-–∫–æ–≥–æ –¥–ª—è —Ç–µ–±—è ;) –ó–∞–∫–∞–Ω—á–∏–≤–∞–π —Å –≤–æ–ø—Ä–æ—Å–æ–º –≤—ã—à–µ –∏ —É–≤–∏–¥–∏—à—å –∫—Ç–æ —ç—Ç–æ",
            6 => "1. –ó–∞–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∫–µ—Ç—É –∑–∞–Ω–æ–≤–æ.",
            7 => "–û—Ç–ª–∏—á–Ω–æ! –ù–∞–¥–µ—é—Å—å —Ö–æ—Ä–æ—à–æ –ø—Ä–æ–≤–µ–¥–µ—Ç–µ –≤—Ä–µ–º—è ;) –¥–æ–±–∞–≤–ª—è–π –≤ –¥—Ä—É–∑—å—è",
            8 => "–ú—ã —Ç–µ–±—è –ø–æ–º–Ω–∏–º! –•–æ—á–µ—à—å —Å–Ω–æ–≤–∞ –ø–æ–æ–±—â–∞—Ç—å—Å—è —Å –∫–µ–º-—Ç–æ –Ω–æ–≤—ã–º?",
            9 => "–ü–æ–¥–æ–∂–¥–µ–º –ø–æ–∫–∞ –∫—Ç–æ-—Ç–æ —É–≤–∏–¥–∏—Ç —Ç–≤–æ—é –∞–Ω–∫–µ—Ç—É",
            10 => "–ï—Å—Ç—å –≤–∑–∞–∏–º–Ω–∞—è —Å–∏–º–ø–∞—Ç–∏—è! –î–æ–±–∞–≤–ª—è–π –≤ –¥—Ä—É–∑—å—è -",
            11 => "–¢—ã –ø–æ–Ω—Ä–∞–≤–∏–ª—Å—è –¥–µ–≤—É—à–∫–µ, –ø–æ–∫–∞–∑–∞—Ç—å –µ—ë?",
            12 => "–í–∑—è—Ç—å –º–æ—ë –æ—Å–Ω–æ–≤–Ω–æ–µ —Ñ–æ—Ç–æ –∏–∑ –í–ö",
            13 => "–ü—Ä–∏–∫—Ä–µ–ø–∏ –∫ —Å–æ–æ–±—â–µ–Ω–∏—é —Ñ–æ—Ç–æ",
            14 => "–ù–µ—Ç —Ç–∞–∫–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞, –Ω–∞–ø–∏—à–∏ –æ–¥–Ω—É —Ü–∏—Ñ—Ä—É",
            15 => "–ø—Ä–∏—à–ª–∏ –º–Ω–µ —Å–≤–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –∏ —É–≤–∏–¥–∏—à—å –∫—Ç–æ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è —Ä—è–¥–æ–º",
            16 => "—Ö–æ—á–µ—à—å –±–æ–ª—å—à–µ –≤–∑–∞–∏–º–æ–∫? –ñ–º–∏ üíå –∏ —Å–ø—Ä–æ—Å–∏ —á—Ç–æ-–ª–∏–±–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–µ —É –¥–µ–≤—É—à–∫–∏. –û–Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –æ—Ç–≤–µ—Ç–∏—Ç ‚ù§",
            17 => "–ö–æ–º—É-—Ç–æ –ø–æ–Ω—Ä–∞–≤–∏–ª–∞—Å—å —Ç–≤–æ—è –∞–Ω–∫–µ—Ç–∞! –ó–∞–∫–∞–Ω—á–∏–≤–∞–π —Å –≤–æ–ø—Ä–æ—Å–æ–º –≤—ã—à–µ –∏ –ø–æ—Å–º–æ—Ç—Ä–∏–º –∫—Ç–æ —ç—Ç–æ",
            18 => "–°–æ–æ–±—â–µ–Ω–∏–µ —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ. –ù–∞–ø–∏—à–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –¥–ª—è —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ 1 —á—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å –ø–æ–∏—Å–∫–∏",
            19 => "–í —Ç–≤–æ–µ–π –∞–Ω–∫–µ—Ç–µ —Å–æ–≤—Å–µ–º –Ω–µ—Ç —Ç–µ–∫—Å—Ç–∞, –µ—Å–ª–∏ —Ç—ã –Ω–∞–ø–∏—à–µ—à—å –Ω–µ–º–Ω–æ–≥–æ –æ —Å–µ–±–µ –∏ –∫–æ–≥–æ –∏—â–µ—à—å, –º—ã —Å–º–æ–∂–µ–º –ª—É—á—à–µ –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ç–µ–±–µ –ø–∞—Ä—É.",
            20 => "–¢–∞–∫ —Ç—ã –Ω–µ —É–∑–Ω–∞–µ—à—å, —á—Ç–æ –∫–æ–º—É-—Ç–æ –Ω—Ä–∞–≤–∏—à—å—Å—è",
            21 => "–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ, –∫–æ–≥–æ —Ö–æ—á–µ—à—å –Ω–∞–π—Ç–∏, —á–µ–º –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å –∑–∞–Ω—è—Ç—å—Å—è",
            22 => "–ù–∞–ø–∏—à–∏ –æ —Å–µ–±–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –ø–æ–∏–Ω—Ç–µ—Ä–µ—Å–Ω–µ–µ",
            23 => "–¢–∞–∫ —Ç—ã –Ω–µ —É–∑–Ω–∞–µ—à—å, —á—Ç–æ –∫–æ–º—É-—Ç–æ –Ω—Ä–∞–≤–∏—à—å—Å—è... –¢–æ—á–Ω–æ —Ö–æ—á–µ—à—å –æ—Ç–∫–ª—é—á–∏—Ç—å —Å–≤–æ—é –∞–Ω–∫–µ—Ç—É?",
            24 => "–ù–µ—Ç —Ç–∞–∫–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞"
        ];

        $request->validate([
            'User' => 'required|exists:account_listings,id',
            'MessageGroup' => 'required|exists:messages,id'
        ]);

        // –ü–æ–ª—É—á–∞–µ–º ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≥—Ä—É–ø–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π
        $selectedUserId = $request->input('User');
        $selectedMessageGroupId = $request->input('MessageGroup');

        // –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω –¥–æ—Å—Ç—É–ø–∞ –∏ –≥—Ä—É–ø–ø—É —Å–æ–æ–±—â–µ–Ω–∏–π
        $access_token = AccountListing::find($selectedUserId)->Hash;
        $messageGroup = Message::find($selectedMessageGroupId);

        $messagesArray = [
            'name_group' => $messageGroup->name_group,
            'messages' => [
                $messageGroup->message_1,
                $messageGroup->message_2,
                $messageGroup->message_3,
                $messageGroup->message_4,
            ],
        ];

        dispatch(new VkProcessingJob($access_token, $mess_pass, $messagesArray));

        return redirect()->back()->with('message', '–ü—Ä–æ—Ü–µ—Å—Å –∑–∞–ø—É—â–µ–Ω.');
    }

}
